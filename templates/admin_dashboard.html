<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
/* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† */
.card { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
.card.bg-danger { background-color: #dc3545; color: white; }
.card-title { margin-top: 0; }
.btn { padding: 8px 15px; border: none; cursor: pointer; border-radius: 4px; }
.btn-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.btn-warning { background-color: #ffc107; color: #212529; }
.admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.orders-list { max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 6px;}
.order-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 6px; background-color: #f9f9f9;}
.order-items-details { margin-top: 10px; padding: 5px; border-top: 1px dashed #ddd; font-size: 0.9em; }
.popup {
    position: fixed;
    top: 20px;
    left: 20px;
    background: #28a745;
    color: #fff;
    padding: 12px 18px;
    border-radius: 8px;
    z-index: 9999;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    display: none;
}
</style>
</head>
<body>
<nav class="topnav">
<div class="logo"> admin - Mina Munir</div>
<div><a href="{{ url_for('logout') }}">Ø®Ø±ÙˆØ¬</a> | <a href="{{ url_for('menu') }}">Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a></div>
</nav>
<main class="container">
<section class="admin-grid">
    
    <div class="card">
        <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
        <table class="table">
            <thead><tr><th>ID</th><th>Ø§Ø³Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>ØªØ¹Ø¯ÙŠÙ„</th></tr></thead>
            <tbody>
            {% for p in products %}
            <tr data-id="{{ p.id }}">
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td class="price-cell">{{ "%.2f"|format(p.price) }}</td>
                <td>
                    <input class="new-price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯" step="0.01">
                    <button class="btn update-price-btn">Ø­ÙØ¸</button>
                    <button class="btn delete-product-btn">Ø­Ø°Ù</button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <div class="add-product">
            <h4>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="new_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="new_price" placeholder="Ø§Ù„Ø³Ø¹Ø±" step="0.01">
            <input type="text" id="new_image" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
            <input type="text" id="new_category" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ">
            <button id="addProductBtn" class="btn">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
    </div>

    <div class="card">
        <h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h3>
        <div class="orders-list" id="ordersList">
            <p>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
        </div>

        <hr>
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h5 class="card-title">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ±Ø©</h5>
                <p class="card-text">Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù„Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…. **Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!**</p>
                
                <form id="deleteAllOrdersForm" method="POST" action="{{ url_for('delete_all_orders') }}"
                    onsubmit="return confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ Ù‡Ø°Ø§ Ø³ÙŠØ¤Ø¯ÙŠ Ù„Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù….');">
                    
                    <input type="hidden" name="csrf_token" value="{{ session.get('csrf_token', '') }}">
                    
                    <button type="submit" class="btn btn-warning btn-lg text-dark" style="width: 100%;">
                        Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>
</main>

<div id="newOrderPopup" class="popup">âš¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„!</div>

<audio id="notifySound" src="{{ url_for('static', filename='notify.wav') }}" preload="auto"></audio>

<input type="hidden" id="csrf_token" value="{{ session.get('csrf_token', '') }}">
<input type="hidden" id="initial_last_order_id" value="{{ orders[-1].order_id if orders and orders|length > 0 else '' }}">

<script>
document.addEventListener('DOMContentLoaded', () => {

    const csrfToken = document.getElementById('csrf_token') ? document.getElementById('csrf_token').value : '';
    const notifySound = document.getElementById('notifySound');
    const popup = document.getElementById('newOrderPopup');
    
    let lastOrderId = document.getElementById('initial_last_order_id').value || null;
    let pollingInterval = 4000; // 3 Ø«ÙˆØ§Ù†ÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù…

    let orderPollingInterval = null;

    // =================================================================================
    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    // =================================================================================
    function formatNumber(n) {
        const num = Number(n || 0);
        if (Number.isNaN(num)) return '0.00';
        return num.toFixed(2);
    }

    // âœ… ØªØµØ­ÙŠØ­ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ù‚ÙŠÙ… (Sanitization) - Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø£Ù…Ø§Ù†
    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": "'", 
        };
        return unsafe.toString().replace(/[&<>"']/g, (m) => map[m]);
    }

    // =================================================================================
    // POST helper (Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¢Ù…Ù†Ø©: ÙŠØ¯Ø¹Ù… CSRF ÙÙŠ Header Ø£Ùˆ ÙƒØ­Ù‚Ù„ FormData)
    // =================================================================================
    async function sendAdminRequest(url, body = null, formData = null) {
        if (!csrfToken) {
            alert('Ø®Ø·Ø£ Ø£Ù…Ù†ÙŠ: Ø±Ù…Ø² CSRF ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
            return { success: false, message: 'Ø®Ø·Ø£ Ø£Ù…Ù†ÙŠ' };
        }

        const headers = {};
        let requestBody;

        if (formData) {
            formData.append('csrf_token', csrfToken);
            requestBody = formData;
            // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ¹ÙŠÙŠÙ† Content-Type Ù„Ù€ FormData
        } else {
            // Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª JSON Ø£Ùˆ POST Ø§Ù„ÙØ§Ø±ØºØ©
            headers['Content-Type'] = 'application/json';
            headers['X-CSRFToken'] = csrfToken;
            requestBody = body ? JSON.stringify(body) : JSON.stringify({});
        }

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: formData ? {} : headers, // Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Headers Ù…Ø¹ FormData
                body: requestBody
            });
            if (res.status === 403) {
                return { success: false, message: 'Forbidden - Ø®Ø·Ø£ Ø£Ù…Ù†ÙŠ: Ø±Ù…Ø² CSRF ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.' };
            }
            return res.json();
        } catch (e) {
            console.error("Fetch error:", e);
            return { success: false, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….' };
        }
    }

    // =================================================================================
    // CRUD Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    // (ÙŠØ³ØªØ®Ø¯Ù… sendAdminRequest Ø§Ù„Ø¢Ù…Ù†)
    // =================================================================================
    document.addEventListener('click', async (e) => {
        const tr = e.target.closest('tr');
        if (!tr) return;
        const id = tr.getAttribute('data-id');

        if (e.target.classList.contains('update-price-btn')) {
            const priceInput = tr.querySelector('.new-price');
            const price = priceInput.value;
            if (!price || parseFloat(price) <= 0) {
                return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­ ÙˆÙ…ÙˆØ¬Ø¨.');
            }

            const form = new FormData();
            form.append('id', id);
            form.append('price', price);

            const j = await sendAdminRequest("{{ url_for('update_price') }}", null, form);
            alert(j.message);
            if (j.success) {
                tr.querySelector('.price-cell').textContent = formatNumber(price);
                priceInput.value = '';
            }
        }

        if (e.target.classList.contains('delete-product-btn')) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;

            const j = await sendAdminRequest("{{ url_for('delete_product') }}", { id: id });
            alert(j.message);
            if (j.success) {
                tr.remove();
            }
        }
    });

    document.getElementById('addProductBtn')?.addEventListener('click', async () => {
        const name = document.getElementById('new_name').value;
        const price = document.getElementById('new_price').value;
        const image = document.getElementById('new_image').value;
        const category = document.getElementById('new_category').value;

        if (!name || !price || parseFloat(price) <= 0) {
            return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
        }

        const j = await sendAdminRequest("{{ url_for('add_product') }}", { name, price, image, category });
        alert(j.message);
        if (j.success) {
            location.reload();
        }
    });

    // =================================================================================
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© - poll + notification + render
    // =================================================================================

    function showPopup(text) {
        popup.textContent = text;
        popup.style.display = 'block';
        setTimeout(()=> popup.style.display = 'none', 6000);
    }

    function renderOrders(orders) {
        const container = document.getElementById("ordersList");
        if (!container) return;
        container.innerHTML = "";

        // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
        orders.slice().reverse().forEach(o => {
            const user = escapeHtml(o.user || 'Ø¶ÙŠÙ');
            const mobile = escapeHtml(o.mobile);
            const timestamp = escapeHtml(o.timestamp);
            const order_id = escapeHtml(o.order_id);
            const total = formatNumber(o.total || 0);

            // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø·Ù„Ø¨
            const itemsList = (o.order_items || []).map(item =>
                // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… escapeHtml Ù„Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø¨Ù„ Ø¹Ø±Ø¶Ù‡Ø§
                `${escapeHtml(item.name || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')} Ã— ${escapeHtml(item.qty || 1)} (${formatNumber(item.price || 0)} Ø¬.Ù…)`
            ).join('<br>');

            let locationHtml = escapeHtml(o.location || '');
            if (o.location && typeof o.location === 'string' && o.location.startsWith('GPS:')) {
                const coords = encodeURIComponent(o.location.split('GPS:')[1].trim());
                // âœ… ØªØµØ­ÙŠØ­ Ø±Ø§Ø¨Ø· Google Maps
                locationHtml = `<a href="https://maps.google.com/?q=${coords}" target="_blank" style="color: blue; text-decoration: underline;">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>`;
            }

            container.innerHTML += `
                <div class="order-box">
                    <h4>Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${order_id} - ${total} Ø¬.Ù…</h4>
                    <p>ğŸ™‹â€â™‚ï¸ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${user}</p>
                    <p>ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: ${mobile}</p>
                    <p>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${locationHtml}</p>
                    <p>ğŸ“… Ø§Ù„ÙˆÙ‚Øª: ${timestamp}</p>
                    <div class="order-items-details">
                        <strong>ğŸ›’ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:</strong><br>
                        ${itemsList}
                    </div>
                </div>
            `;
        });
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø¢Ø®Ø± order_id
    async function pollOrders() {
        try {
            // âœ… ØªØµØ­ÙŠØ­ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯ ('get_orders' Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 'check_new_orders')
            const res = await fetch("{{ url_for('get_orders') }}", { cache: "no-store" });

            if (res.status === 403) {
                console.warn("Not authorized as Admin. Stopping polling.");
                if (orderPollingInterval) clearInterval(orderPollingInterval);
                return;
            }
            if (!res.ok) {
                console.error("Failed to fetch orders:", res.status);
                return;
            }
            
            const data = await res.json();
            if (!data.success) return;

            const orders = data.orders || [];
            const newest = orders.length ? orders[orders.length - 1].order_id : null;

            const shouldRender = !lastOrderId || (newest && newest !== lastOrderId);

            if (shouldRender) {
                // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ù€ popup Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                if (lastOrderId && newest && newest !== lastOrderId) {
                    try { 
                        // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¶Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©
                        notifySound.currentTime = 0; 
                        notifySound.play().catch(()=>{}); 
                    } catch(e) {}
                    showPopup(`âš¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ #${escapeHtml(newest)}`);
                }

                renderOrders(orders);

                if (newest) lastOrderId = newest;
            }
        } catch (e) {
            console.error("pollOrders error:", e);
            const container = document.getElementById("ordersList");
            if (container && container.innerHTML.includes('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„')) {
                container.innerHTML = '<p style="color:red;">ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø®Ø§Ø¯Ù….</p>';
            }
        }
    }

    // Ø§Ø¨Ø¯Ø£ Ø§Ù„Polling
    // Ø§Ø¨Ø¯Ø£ Ø§Ù„Polling
Â  Â  if (document.getElementById("ordersList")) {
Â  Â  Â  Â  pollOrders();
Â  Â  Â  Â  orderPollingInterval = setInterval(pollOrders, pollingInterval);
Â  Â  }

    // =================================================================================
    // ğŸ§ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Autoplay)
    // =================================================================================
    // Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø© Ø£Ùˆ ØªÙØ§Ø¹Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.
    // Ù‡Ø°Ø§ "ÙŠØ­Ø±Ø±" (Unlocks) Ø¥Ø°Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ Ø¯Ø§Ù„Ø© pollOrders.
    
    let isSoundUnlocked = false;

    function unlockSound(e) {
        if (isSoundUnlocked) {
            document.removeEventListener('click', unlockSound);
            return;
        }
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù‚Ø¯ ÙŠÙØ´Ù„)ØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù‡Ø¯Ù Ù‡Ùˆ "ÙØªØ­" Ø§Ù„Ø¥Ø°Ù†
        try {
            notifySound.play().catch(err => {
                // Ù‚Ø¯ ØªÙØ´Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ù„ÙƒÙ† Ø§Ù„Ù…Ù‡Ù… Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ Ø³Ø¬Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„
                console.log("Autoplay failed, but interaction registered.");
            });
            notifySound.pause(); // Ù†ÙˆÙ‚ÙÙ‡Ø§ ÙÙˆØ±Ø§Ù‹
            notifySound.currentTime = 0;
            isSoundUnlocked = true;
        } catch(err) {
            console.error("Error unlocking audio:", err);
        }
        
        // Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ØŒ Ù†Ø²ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ø¹Ø¯Ù… Ø§Ù„Ø­Ø§Ø¬Ø© Ø¥Ù„ÙŠÙ‡
        document.removeEventListener('click', unlockSound);
        document.removeEventListener('scroll', unlockSound);
    }

    // Ø§Ø³ØªÙ…Ø¹ Ù„Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø© Ø£Ùˆ ØªÙ…Ø±ÙŠØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('click', unlockSound, { once: true });
    document.addEventListener('scroll', unlockSound, { once: true }); 
});
</script>
</body>
</html>
